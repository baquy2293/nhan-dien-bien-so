<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Video Stream</title>

    <!-- Custom fonts for this template-->
    <link rel="stylesheet" href="{{url_for('static', filename='vendor/fontawesome-free/css/all.min.css')}}">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">

    <!-- Custom styles for this template-->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/sb-admin-2.min.css') }}">
</head>

<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Sidebar -->
        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">

            <!-- Sidebar - Brand -->
            <a class="sidebar-brand d-flex align-items-center justify-content-center" href="#">
                <div class="sidebar-brand-icon rotate-n-15">
                    <i class="fas fa-laugh-wink"></i>
                </div>
                <div class="sidebar-brand-text mx-3">Admin <sup>2</sup></div>
            </a>

            <!-- Divider -->
            <hr class="sidebar-divider my-0">

            <!-- Nav Item - Dashboard -->
            <li class="nav-item active">
                <a class="nav-link" href="#">
                    <i class="fas fa-fw fa-tachometer-alt"></i>
                    <span>Dashboard</span></a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Heading -->


            <!-- Nav Item - Pages Collapse Menu -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="{{url_for('logout')}}" data-toggle="collapse"
                    data-target="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo">
                    <i class="fas fa-fw fa-cog"></i>
                    <span>Login</span>
                </a>

            </li>
            <!-- Nav Item - Utilities Collapse Menu -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="{{url_for('logout')}}" data-toggle="collapse"
                    data-target="#collapseUtilities" aria-expanded="true" aria-controls="collapseUtilities">
                    <i class="fas fa-fw fa-wrench"></i>
                    <span>Logout</span>
                </a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Heading -->
            <div class="sidebar-heading">
                About
            </div>

            <!-- Nav Item - Pages Collapse Menu -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="{{url_for('monthly')}}">
                    <i class="fas fa-chart-bar bold-icon"></i>
                    <span>Statistics</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link collapsed" href="{{url_for('statisticals')}}">
                    <i class="fas fa-fw fa-folder"></i>
                    <span>Pages</span>
                </a>
            </li>

            <!-- Nav Item - Charts -->
            <li class="nav-item">
                <a class="nav-link" href="{{url_for('admin')}}">
                    <i class="fas fa-fw fa-chart-area"></i>
                    <span>User</span></a>
            </li>

            <!-- Nav Item - Tables -->
            <li class="nav-item">
                <a class="nav-link" href="{{url_for('videoplayback')}}">
                    <i class="fas fa-fw fa-table"></i>
                    <span>History</span></a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider d-none d-md-block">

            <!-- Sidebar Toggler (Sidebar) -->
            <div class="text-center d-none d-md-inline">
                <button class="rounded-circle border-0" id="sidebarToggle"></button>
            </div>

            <!-- Sidebar Message -->


        </ul>
        <!-- End of Sidebar -->

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">
            <!-- Main Content -->
            <div id="content">
                <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">

                    <!-- Sidebar Toggle (Topbar) -->
                    <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                        <i class="fa fa-bars"></i>
                    </button>

                    <!-- Topbar Search -->
                    <form
                        class="d-none d-sm-inline-block form-inline mr-auto ml-md-3 my-2 my-md-0 mw-100 navbar-search">
                        <div class="input-group">
                            <P>ACTVN</P>
                        </div>
                    </form>

                </nav>
                <div class="container-fluid">
                    <!-- Content Row -->
                    <div class="row">
                        <div class="col-xl-8">
                            <div class="row" style="display: flex; justify-content: center; margin-top: 10px;">
                                <!-- Earnings (Monthly) Card Example -->
                                <div class="col-xl-5 col-md-6 mb-4">
                                    <div class="card border-left-primary shadow h-100 py-2">
                                        <div class="card-body">
                                            <div class="row no-gutters align-items-center">
                                                <div class="col mr-2">
                                                    <div
                                                        class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                                        Date Time</div>
                                                    <div id="currentDate"
                                                        class="h5 mb-0 font-weight-bold text-gray-800">
                                                    </div>
                                                </div>
                                                <div class="col-auto">
                                                    <i class="fas fa-calendar fa-2x text-gray-300"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Earnings (Monthly) Card Example -->
                                <div class="col-xl-3 col-md-6 mb-4">
                                    <div class="card border-left-success shadow h-100 py-2">
                                        <div class="card-body">
                                            <div class="row no-gutters align-items-center">
                                                <div class="col mr-2">
                                                    <div
                                                        class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                                        Spaces
                                                    </div>
                                                    <div id="spaces-content"
                                                        class="h5 mb-0 font-weight-bold text-gray-800">
                                                        {{spaces}}
                                                    </div>
                                                </div>
                                                <div class="col-auto">
                                                    <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-xl-4 col-md-6 mb-4">
                                    <div class="card border-left-warning shadow h-100 py-2">
                                        <div class="card-body">
                                            <div class="row no-gutters align-items-center">
                                                <div class="col mr-2">
                                                    <div
                                                        class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                                        Vehicle status
                                                    </div>
                                                    <!-- Cập nhật ID của phần tử để phù hợp với JavaScript -->
                                                    <div class="h5 mb-0 font-weight-bold text-gray-800"
                                                        id="vehicle-status-text"> {{filtered_string_in}}</div>
                                                </div>
                                                <div class="col-auto">
                                                    <i class="fas fa-comments fa-2x text-gray-300"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Content Row -->

                            <div class="row ">
                                <div class="row justify-content-center">
                                    <div class="col-xl-6 col-lg-6">
                                        <p>Entrance gate</p>
                                        <img src="http://ras:8080/?action=stream"
                                            style="width: 100%; border: 1mm solid #4e73df; border-radius: 10px;">
                                        <div class="row justify-content-center" id="buttonRow"
                                            style="width: 100%; margin-top: 10px; margin-left: 0px;">
                                            <div class="col-md-6 d-none d-md-block justify-content-center">
                                                <button type="button" style="margin-top: 10px;"
                                                    class="btn btn-primary btn-block"
                                                    onclick="openServo_enter()">Open</button>
                                            </div>
                                            <div class="col-md-6 d-none d-md-block justify-content-center">
                                                <button type="button" style="margin-top: 10px;"
                                                    class="btn btn-primary btn-block"
                                                    onclick="closeServo_enter()">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xl-6 col-lg-6">
                                        <p>Exit gate</p>
                                        <img src="http://pi:8080/?action=stream"
                                            style="width: 100%; border: 1mm solid #4e73df; border-radius: 10px;">
                                        <div class="row justify-content-center" id="buttonRow"
                                            style="width: 100%; margin-top: 10px; margin-left: 0px;">
                                            <div class="col-md-6 d-none d-md-block justify-content-center">
                                                <button type="button" style="margin-top: 10px;"
                                                    class="btn btn-primary btn-block"
                                                    onclick="openServo_exit()">Open</button>
                                            </div>
                                            <div class="col-md-6 d-none d-md-block justify-content-center">
                                                <button type="button" style="margin-top: 10px;"
                                                    class="btn btn-primary btn-block"
                                                    onclick="closeServo_exit()">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-4  mt-3">
                            <div class="col-xl-11 justify-content-center">
                                <div class="card shadow mb-4">
                                    <!-- Card Header - Dropdown -->
                                    <div class="card-header py-3">
                                        <h6 class="m-0 font-weight-bold text-white">About Lincese Plate Entered</h6>
                                    </div>
                                    <!-- Card Body -->
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-xl-6">
                                                <p>Enter</p>
                                                <img id="enter-image" class="reload" alt="Enter Image"
                                                    src="{{ url_for('static', filename='cropped_image_out.jpg') }}"
                                                    style="width: 100%; height: auto; border: 2px solid #4e73df; border-radius: 10px;">
                                            </div>
                                            <div class="col-xl-6">
                                                <p>Exit</p>
                                                <img id="exit-image" class="reload" alt="Exit Image"
                                                    src="{{ url_for('static', filename='cropped_image_out.jpg') }}"
                                                    style="width: 100%; height: auto; border: 2px solid #4e73df; border-radius: 10px;">
                                            </div>
                                        </div>
                                        <!-- Phần nhận từ API in -->
                                        <div id="video-info" class="row"
                                            style="display: block; padding-left: 15px; padding-top: 15px;">
                                            <p id="video-id" style="color: black; display: block;">ID: </p>
                                            <p id="video-name" style="color: black; display: block;">Name: </p>
                                            <p id="video-department" style="color: black; display: block;">Department:
                                            </p>
                                            <p id="video-text" style="color: black; display: block;">License plate: </p>
                                        </div>
                                    </div>
                                </div>

                            </div>

                        </div>
                    </div>
                </div>
            </div>

        </div>
        <a class="scroll-to-top rounded" href="#page-top">
            <i class="fas fa-angle-up"></i>
        </a>
        <!-- <div id="result"></div> -->
        <button id="confirmButton" style="display:none;" onclick="confirmSendTextApi()">Confirm Send</button>
        <!-- Logout Modal-->
        <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">F
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
                        <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">×</span>
                        </button>
                    </div>
                    <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                        <a class="btn btn-primary" href="{{url_for('logout')}}">Logout</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap core JavaScript-->
        <script src="{{ url_for('static', filename='vendor/jquery/jquery.min.js') }}"></script>
        <script src="{{ url_for('static', filename='vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
        <script src="{{ url_for('static', filename='vendor/jquery-easing/jquery.easing.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/sb-admin-2.min.js') }}"></script>
        <script src="{{ url_for('static', filename='vendor/chart.js/Chart.min.js') }}"></script>
        <script src="{{ url_for('static', filename='js/demo/chart-area-demo.js') }}"></script>
        <script src="{{ url_for('static', filename='js/demo/chart-pie-demo.js') }}"></script>
        <script>
            window.onload = () => {
                const updateImages = () => {
                    document.querySelectorAll("img.reload").forEach((el) => {
                        if (el.complete) {
                            el.src = el.src.split("?")[0] + "?" + new Date().getTime();
                        }
                    });
                }
                setInterval(updateImages, 200);
            }


            function callOutApi() {
                fetch('/api/video/in')
                    .then(response => response.json())
                    .then(data => {
                        // Cập nhật dữ liệu từ API out vào phần tử HTML tương ứng
                        document.getElementById('vehicle-status-text').textContent = data.data;
                        console.log('Out API called', data);
                        // if (data.status === 'success' & data.data != "") {
                        //     fetch('http://ras:5001/open', {
                        //         method: 'POST'
                        //     })
                        //         .then(response => response.json())
                        //         .then(data => {
                        //             console.log('Servo opened:', data);
                        //         })
                        //         .catch(error => console.error('Error opening servo:', error));
                        // }

                    })
                    .catch(error => console.error('Error:', error));
                setTimeout(callOutApi, 5000)
            }



            function callInApi() {
                fetch('/api/video/out')
                    .then(response => response.json())
                    .then(data => {
                        // Cập nhật dữ liệu từ API out vào các phần tử HTML tương ứng
                        document.getElementById('video-id').textContent = `ID: ${data.id || ''}`;
                        document.getElementById('video-name').textContent = `Name: ${data.name || ''}`;
                        document.getElementById('video-department').textContent = `Department: ${data.department || ''}`;
                        document.getElementById('video-text').textContent = `License plate: ${data.data || ''}`;
                        console.log('Out API called', data);
                        // if (data.status === 'success' & data.data != "") {
                        //     fetch('http://pi:5001/open', {
                        //         method: 'POST'
                        //     })
                        //         .then(response => response.json())
                        //         .then(data => {
                        //             console.log('Servo opened:', data);
                        //         })
                        //         .catch(error => console.error('Error opening servo:', error));
                        // }
                    })
                    .catch(error => console.error('Error:', error));
                setTimeout(callInApi, 5000)
            }
            callInApi();
            callOutApi();
            function updateSpaces() {
                const xhr = new XMLHttpRequest();
                xhr.open('GET', '/get_sensor_data', true);
                xhr.onreadystatechange = function () {

                    if (xhr.readyState === 4 && xhr.status === 200) {
                        document.getElementById('spaces-content').innerHTML = xhr.responseText;
                    }
                };
                xhr.send();
            }

            // Tự động tải lại nội dung mỗi 5 giây (5000 milliseconds)
            setInterval(updateSpaces, 1000);
            // Gọi hàm lần đầu tiên để tải nội dung ngay khi trang được tải
            updateSpaces();
            let flag = 0;
            
            function callSendTextApi() {
                fetch('/api/send_text_in', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                })
                    .then(response => response.json())
                    .then(data => {
                        
                        if (data.status === "success") {
                            console.log('Success:', data);
                            confirmSendTextApi();  // Automatically confirm if success
                            console.log(flag)
                            flag = 0;
                            console.log(flag)
                            //alert(flag)
                        } else if (data.status === "failure_nodata") {
                           // alert(flag)
                            if (flag == 0) {
                                console.error('Failure:', data);
                                // document.getElementById('result').innerText = "Failure: " + (data.error || "Unknown error");
                                if (data.error === "License plate not found. Confirm to proceed.") {
                                    if (confirm(data.error)) {
                                        confirmSendTextApi();
                                    }
                                }
                                flag = 1;
                            }

                        }
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                        document.getElementById('result').innerText = `Error: ${error}`;
                    });
            }

            function confirmSendTextApi() {
                fetch('/api/confirm_send_text_in', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === "success") {
                            console.log('Confirmation Success:', data);
                            // document.getElementById('result').innerText = "Confirmation Success";
                        } else {
                            console.error('Confirmation Failure:', data);
                            // document.getElementById('result').innerText = "Confirmation Failure: " + (data.error || "Unknown error");
                        }
                        document.getElementById('confirmButton').style.display = "none";
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                        // document.getElementById('result').innerText = `Error: ${error}`;
                        document.getElementById('confirmButton').style.display = "none";
                    });
            }
            function callSendTexOuttApi() {
                fetch('/api/send_text_out', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Success:', data);
                        document.getElementById('result').innerText = JSON.stringify(data);
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                        document.getElementById('result').innerText = `Error: ${error}`;
                    });
            }

            // Call the API every 5 seconds
            setInterval(callSendTexOuttApi, 5000);
            // Call the API every 5 seconds
            setInterval(callSendTextApi, 5000);
            function updateDateTime() {
                // Lấy ngày tháng hiện tại
                var today = new Date();

                // Format ngày tháng
                var dd = String(today.getDate()).padStart(2, '0');
                var mm = String(today.getMonth() + 1).padStart(2, '0'); // Tháng bắt đầu từ 0
                var yyyy = today.getFullYear();
                var hh = String(today.getHours()).padStart(2, '0');
                var min = String(today.getMinutes()).padStart(2, '0');
                var sec = String(today.getSeconds()).padStart(2, '0');
                var currentDate = hh + ':' + min + ':' + sec + ' ' + dd + '/' + mm + '/' + yyyy;

                // Hiển thị ngày tháng hiện tại lên HTML
                document.getElementById('currentDate').innerText = currentDate;
            }

            // Cập nhật ngày và thời gian mỗi giây
            setInterval(updateDateTime, 1000);

            document.addEventListener("DOMContentLoaded", function () {
                var videoElement = document.getElementById('videoElement');
                var videoElement1 = document.getElementById('videoElement1');

                if (Hls.isSupported()) {
                    var hls1 = new Hls();
                    hls1.loadSource('http://100.106.151.8:8080/stream.html');
                    hls1.attachMedia(videoElement);

                    var hls2 = new Hls();
                    hls2.loadSource('http://100.74.97.91:8080/stream.html');
                    hls2.attachMedia(videoElement1);
                } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                    videoElement.src = 'http://100.106.151.8:8080/stream.html';
                    videoElement1.src = 'http://100.74.97.91:8080/stream.html';
                }
            });
            function openServo_enter() {
                // alert('Mở cửa thành công');
                fetch('http://ras:5001/open', {
                    method: 'POST'
                });
            }

            function closeServo_enter() {
                // alert('Đóng cửa thành công');
                fetch('http://ras:5001/close', {
                    method: 'POST'
                });
            }
            function openServo_exit() {
                // alert('Mở cửa thành công');
                fetch('http://pi:5001/open', {
                    method: 'POST'
                });
            }

            function closeServo_exit() {

                // alert('Đóng cửa thành công');
                fetch('http://pi:5001/close', {
                    method: 'POST'
                });
            }

        </script>
</body>

</html>